import os
import re
import time
from rich.console import Console
from rich.panel import Panel
from rich.text import Text
from rich.align import Align
from rich.progress import track
from rich.table import Table
from rich import box

console = Console()

OUTPUT_DIR = "/storage/emulated/0/ML/SKIN RANGE PROCESSOR/"
SKIN_REGEX = re.compile(r"skin\s*[:=]?\s*(\d+)", re.IGNORECASE)
LOGIN_REGEX = re.compile(r"Last Log in:\s*(\d{4}-\d{2}-\d{2})")
DECORATION_CHARS = "‚ïê‚ïî‚ïó‚ïë‚ïù‚ïö"

def show_banner():
    banner = Text()
    banner.append(" HOSH | SKIN PROCESSOR\n", style="bold white")
    banner.append(" dm telegram @fireHsoh", style="magenta")
    panel = Panel(
        Align.center(banner, vertical="middle"),
        box=box.SQUARE,
        padding=(1, 4),
        border_style="cyan",
        width=60
    )
    console.print(Align.center(panel))

def is_decorative(line):
    return any(c in line for c in DECORATION_CHARS)

def list_txt_files(folder):
    files = [f for f in os.listdir(folder) if f.endswith(".txt")]
    if not files:
        console.print("[red]√ó No .txt files found in the folder.")
        raise SystemExit
    console.print("\n[bold white]Available .txt files:[/]")
    for i, file in enumerate(files, 1):
        console.print(f" [cyan]{i}.[/] {file}")
    return files

def choose_file(folder):
    files = list_txt_files(folder)
    choice = console.input("\n[bold white]Select file by number:[/] ").strip()
    if not choice.isdigit() or int(choice) < 1 or int(choice) > len(files):
        console.print("[red]Invalid choice.")
        raise SystemExit
    return os.path.join(folder, files[int(choice)-1])

def load_blocks(path):
    raw = open(path, "r", encoding="utf-8", errors="ignore").read()
    blocks = [b.strip() for b in raw.split("\n\n") if b.strip()]
    valid, trash = [], []

    now = time.time()

    for b in blocks:
        lines = [l for l in b.splitlines() if l.strip() and not is_decorative(l)]
        joined = "\n".join(lines)

        m = SKIN_REGEX.search(joined)
        login_match = LOGIN_REGEX.search(joined)

        if m and int(m.group(1)) >= 100:
            status = "Unknown"
            if login_match:
                try:
                    last_login = login_match.group(1)
                    t = time.strptime(last_login, "%Y-%m-%d")
                    diff = (now - time.mktime(t)) / 86400
                    status = "Active" if diff <= 3 else "Inactive"
                except:
                    pass
            valid.append((int(m.group(1)), joined, status))
        else:
            trash.append(joined)
    return valid, trash, len(blocks)

def make_bar(pct):
    length = 20
    filled = int(pct/100 * length)
    return "‚ñà"*filled + "‚ñë"*(length-filled)

def generate_distribution(valid):
    ranges = {
        "100‚Äì200": (100,200),
        "201‚Äì300": (201,300),
        "301‚Äì400": (301,400),
        "401‚Äì500": (401,500),
        "501‚Äì600": (501,600),
        "601‚Äì700": (601,700),
    }
    buckets = {r:0 for r in ranges}
    for skin, *_ in valid:
        for r,(lo,hi) in ranges.items():
            if lo<=skin<=hi:
                buckets[r]+=1
    return buckets

def show_summary(fname, valid, total):
    counts = [s for s,_,_ in valid]
    avg = sum(counts)/len(counts) if counts else 0
    minimum = min(counts) if counts else "-"
    maximum = max(counts) if counts else "-"
    active_count = sum(1 for *_, status in valid if status == "Active")
    inactive_count = sum(1 for *_, status in valid if status == "Inactive")

    console.print(Align.center(Text("üìä HOSH | SKIN PROCESSOR", style="bold white")))

    lines = [
        f"‚Ä¢ Selected File     : {fname}",
        f"‚Ä¢ Total Accounts    : {total}",
        f"‚Ä¢ Valid Accounts    : {len(valid)}",
        f"‚Ä¢ Active Accounts   : {active_count}",
        f"‚Ä¢ Inactive Accounts : {inactive_count}",
        f"‚Ä¢ Min Skins         : {minimum}",
        f"‚Ä¢ Max Skins         : {maximum}",
        f"‚Ä¢ Average Skins     : {avg:.1f}"
    ]
    padded_lines = [f"  {line.ljust(56)}" for line in lines]
    border_top = "‚ïî" + "‚ïê" * 58 + "‚ïó"
    border_bottom = "‚ïö" + "‚ïê" * 58 + "‚ïù"
    summary_block = border_top + "\n"
    for line in padded_lines:
        summary_block += f"‚ïë{line}‚ïë\n"
    summary_block += border_bottom

    console.print(Align.center(Text(summary_block, style="bold white")))

    dist = generate_distribution(valid)
    table = Table(
        box=box.SQUARE, padding=(0,1),
        border_style="white", width=60
    )
    table.add_column("Skin Range", justify="center", style="bold white")
    table.add_column("Count", justify="center", style="yellow")
    table.add_column("%", justify="center", style="magenta")
    table.add_column("Distribution Bar", style="cyan")

    console.print(Align.center(Text("\nüìä SKIN COUNT DISTRIBUTION", style="bold white")))
    console.print(Align.center(Text("‚îÄ"*44, style="dim")))

    for r, cnt in dist.items():
        pct = (cnt/len(valid))*100 if valid else 0
        table.add_row(r, str(cnt), f"{pct:.0f}%", make_bar(pct))

    console.print(Align.center(table))

def save_output(valid, trash):
    count = len(valid)
    folder = os.path.join(OUTPUT_DIR, str(count))
    os.makedirs(folder, exist_ok=True)

    hit = os.path.join(folder, f"Hits1[{count}].txt")
    with open(hit, "w", encoding="utf-8") as f:
        for _,blk,status in valid:
            f.write(f"[Status: {status}]\n{blk}\n\n")

    if trash:
        tr = os.path.join(folder, "Trash.txt")
        with open(tr, "w", encoding="utf-8") as f:
            for blk in trash:
                f.write(blk+"\n\n")

    return hit

def main():
    os.system("clear")
    show_banner()
    
    # Use fixed folder path
    folder = "/storage/emulated/0/ML/SKIN RANGE PROCESSOR/"
    if not os.path.isdir(folder):
        console.print("[red]√ó Invalid folder path.")
        raise SystemExit

    path = choose_file(folder)

    valid, trash, total = load_blocks(path)
    console.print()
    for _ in track(range(25), description="[cyan]‚Üí Distributing...", transient=True):
        time.sleep(0.05)

    os.system("clear")
    show_banner()
    show_summary(os.path.basename(path), valid, total)

    out = save_output(valid, trash)
    console.print(f"\n[bold green]‚úì Output saved as:[/] [white]{out}[/]\n")

if __name__ == "__main__":
    main()